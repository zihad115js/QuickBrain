<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quick Brain â€“ Game of Your Brain</title>
  
  <!-- Fonts & Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- User Scripts (Ads/Monetization) -->
  <script src="https://resignedincidentallysurprise.com/f5/ed/b4/f5edb4a78fc0eee93c4f809373d456dd.js"></script>
  <script src="https://5gvci.com/act/files/tag.min.js?z=10601053" data-cfasync="false" async></script>
  
  <style>
    :root {
      --bg-color: #74b9ff;
      --text-color: #2d3436;
      --quiz-bg: #ffffff;
      --button-bg: #dfe6e9;
      --heading-color: #0a3b4b;
      --card-shadow: rgba(0,0,0,0.15);
      --panel-bg: #ffffff;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Fredoka', sans-serif;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      min-height: 100vh;
      background: var(--bg-color);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      color: var(--text-color);
      overflow: hidden;
      transition: background 0.6s ease;
    }

    /* Live Background Particles */
    #live-bg {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      z-index: -1; pointer-events: none; overflow: hidden;
    }

    .particle {
      position: absolute; font-size: 2.5rem;
      animation: floatUp linear infinite; opacity: 0.7;
    }

    @keyframes floatUp {
      0% { transform: translateY(110vh) rotate(0deg) scale(0.8); opacity: 0; }
      10% { opacity: 0.9; }
      90% { opacity: 0.9; }
      100% { transform: translateY(-20vh) rotate(360deg) scale(1.2); opacity: 0; }
    }

    #confetti {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none; z-index: 9999;
    }

    /* main app container */
    .app {
      width: 100%; max-width: 650px;
      background: rgba(255, 255, 255, 0.3); backdrop-filter: blur(12px);
      border-radius: 40px; padding: 25px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
      border: 4px solid rgba(255, 255, 255, 0.6);
      position: relative; z-index: 10;
    }

    /* Welcome Modal */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(8px);
      display: flex; align-items: center; justify-content: center;
      z-index: 99999; opacity: 0; visibility: hidden; transition: 0.3s;
    }
    
    .modal-overlay.active { opacity: 1; visibility: visible; }

    .modal-content {
      background: #fff; border-radius: 40px; padding: 40px 30px; text-align: center; max-width: 400px; width: 90%;
      border: 6px solid #ff9ff3; box-shadow: 0 15px 0 #f368e0, 0 20px 40px rgba(0,0,0,0.3);
      transform: scale(0.7); transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .modal-overlay.active .modal-content { transform: scale(1); }

    .modal-content h2 { font-size: 2.5rem; color: #341f97; margin-bottom: 10px; }
    .modal-content p { font-size: 1.5rem; color: #576574; margin-bottom: 25px; font-weight: 600; }
    
    .modal-input-group { display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 30px; }
    .modal-input-group input {
      width: 120px; font-size: 3.5rem; text-align: center; border-radius: 20px;
      border: 5px solid #48dbfb; color: #0abde3; font-weight: 700; padding: 10px; outline: none;
    }
    
    .modal-btn {
      background: #1dd1a1; border: none; color: white; font-size: 2rem; font-weight: 700;
      padding: 15px 40px; border-radius: 40px; border: 4px solid #fff;
      box-shadow: 0 8px 0 #10ac84; cursor: pointer; transition: 0.1s; width: 100%;
    }
    .modal-btn:active { transform: translateY(8px); box-shadow: none; }

    /* splash screen */
    #splash-screen { display: none; flex-direction: column; align-items: center; text-align: center; padding: 30px 10px; }

    .brain-mascot {
      width: 150px; height: 150px; background: #ff9ff3; border-radius: 50%;
      display: flex; align-items: center; justify-content: center; font-size: 6rem;
      border: 6px solid #f368e0; box-shadow: 0 10px 0 #f368e0, 0 20px 30px rgba(0,0,0,0.2);
      margin-bottom: 20px; animation: bounceMascot 2s infinite;
    }

    @keyframes bounceMascot { 0%, 100% { transform: translateY(0) scale(1); } 50% { transform: translateY(-15px) scale(1.05); } }

    .splash-title {
      font-size: 4rem; font-weight: 800; color: #fff; text-shadow: 0 6px 0 #341f97, 0 10px 15px rgba(0,0,0,0.3);
      letter-spacing: 2px; margin-bottom: 15px; line-height: 1.1;
    }

    .play-now-btn {
      background: #ff4757; border: 4px solid #fff; color: white; font-size: 2.5rem; font-weight: 700;
      padding: 18px 60px; border-radius: 60px; box-shadow: 0 10px 0 #ff6b81, 0 15px 20px rgba(0,0,0,0.2);
      cursor: pointer; margin-top: 30px; display: inline-flex; align-items: center; gap: 15px; animation: pulseBtn 2s infinite;
    }
    @keyframes pulseBtn { 0%, 100%{ transform: scale(1); } 50%{ transform: scale(1.05); } }
    .play-now-btn:active { transform: translateY(10px) scale(1) !important; box-shadow: none; animation: none; }

    /* game screen */
    #game-screen { display: none; }

    /* Top Bar Update - Added Action Buttons Container */
    .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 10px; }

    .btn-chunky {
      background: var(--button-bg); border: 4px solid #fff; color: var(--text-color);
      font-size: 1.5rem; padding: 10px 20px; border-radius: 30px; font-weight: 700;
      cursor: pointer; box-shadow: 0 6px 0 var(--card-shadow); display: flex; align-items: center; gap: 8px;
    }
    .btn-chunky:active { transform: translateY(6px); box-shadow: none; }
    
    .btn-icon-only { width: 55px; height: 55px; padding: 0; justify-content: center; border-radius: 50%; font-size: 1.8rem; }

    .stats { display: flex; gap: 8px; margin-left: auto; margin-right: 10px; }
    .action-btns { display: flex; gap: 10px; } /* New wrapper for shop and settings */

    .stat-badge {
      background: #feca57; padding: 10px 15px; border-radius: 30px; font-size: 1.5rem;
      font-weight: 800; border: 4px solid #fff; box-shadow: 0 5px 0 #ff9f43;
      color: #fff; text-shadow: 1px 1px 0 #d35400; display: flex; align-items: center; gap: 6px;
    }
    .streak { background: #ff6b6b; box-shadow: 0 5px 0 #ee5253; }

    /* quiz card */
    .quiz-card {
      background: var(--quiz-bg); border-radius: 40px; padding: 30px 20px;
      text-align: center; border: 6px solid #fff; box-shadow: 0 15px 0 var(--card-shadow);
      margin-bottom: 15px; position: relative; transition: 0.3s;
    }

    /* NEW Whiteboard Style Math Display */
    .question-board {
      background: #f1f2f6; border: 5px solid #dfe6e9; border-radius: 25px;
      padding: 15px 10px; font-size: 4.5rem; font-weight: 800; color: var(--heading-color);
      box-shadow: inset 0 5px 10px rgba(0,0,0,0.05), 0 8px 0 #b2bec3;
      margin-bottom: 25px; letter-spacing: 2px;
      display: flex; justify-content: center; align-items: center; gap: 15px; flex-wrap: wrap;
    }

    .answer-row { display: flex; justify-content: center; gap: 15px; }

    #answerInput {
      width: 180px; font-size: 3.5rem; text-align: center; border: 6px solid #74b9ff;
      border-radius: 30px; outline: none; font-weight: 800; color: #2d3436;
      box-shadow: inset 0 5px 10px rgba(0,0,0,0.1); transition: 0.2s;
    }
    #answerInput:focus { border-color: #0984e3; transform: scale(1.05); }

    .submit-btn {
      background: #1dd1a1; border: none; color: white; font-size: 3rem; width: 80px; height: 80px;
      border-radius: 30px; cursor: pointer; border: 5px solid #fff; box-shadow: 0 8px 0 #10ac84;
      display: flex; align-items: center; justify-content: center;
    }
    .submit-btn:active { transform: translateY(8px); box-shadow: none; }

    /* Panel Generic Class (For both Shop and Settings) */
    .panel-card {
      background: var(--panel-bg); border-radius: 40px; padding: 25px; border: 6px solid #fff;
      box-shadow: 0 15px 0 var(--card-shadow); display: none; flex-direction: column; gap: 20px;
    }
    .panel-card.visible { display: flex; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    .panel-title { text-align: center; color: #341f97; font-size: 2.2rem; font-weight: 800; margin-bottom: 10px; }

    /* Settings Only Styles */
    .age-selector {
      background: #fff3e0; padding: 20px; border-radius: 25px; border: 4px solid #ffb74d;
      display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;
      font-weight: 700; font-size: 1.8rem; color: #e65100;
    }
    .age-selector input {
      width: 90px; font-size: 2rem; text-align: center; border-radius: 15px; border: 4px solid #ffb74d; font-weight: bold; outline:none;
    }

    /* Shop Only Styles */
    .shop-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 15px; }
    .theme-card {
      background: #f1f2f6; border-radius: 25px; padding: 15px 10px; text-align: center;
      border: 4px solid #dfe6e9; box-shadow: 0 6px 0 #ced6e0; transition: 0.2s;
    }
    .theme-card.equipped { border-color: #1dd1a1; background: #e8f8f5; box-shadow: 0 6px 0 #10ac84; }
    .theme-card-icon { font-size: 3.5rem; margin-bottom: 5px; }
    .theme-card-name { font-size: 1.4rem; font-weight: 800; color: #2d3436; margin-bottom: 10px; }
    
    .theme-action-btn {
      width: 100%; border: 3px solid #fff; border-radius: 20px; padding: 8px 0; font-size: 1.2rem; font-weight: 800; cursor: pointer; color: white; box-shadow: 0 4px 0 rgba(0,0,0,0.2);
    }
    .theme-action-btn:active:not(:disabled) { transform: translateY(4px); box-shadow: none; }
    .theme-action-btn:disabled { opacity: 0.6; cursor: not-allowed; }

    .shake { animation: wrongShake 0.4s; }
    @keyframes wrongShake { 0%, 100% { transform: translateX(0); } 20%, 60% { transform: translateX(-15px) rotate(-3deg); } 40%, 80% { transform: translateX(15px) rotate(3deg); } }
  </style>
</head>
<body>

<!-- Live Background -->
<div id="live-bg"></div>

<!-- Confetti Canvas -->
<canvas id="confetti"></canvas>

<!-- Welcome Modal for First Timers -->
<div class="modal-overlay" id="welcomeModal">
  <div class="modal-content">
    <div class="brain-mascot" style="width:100px; height:100px; font-size:4rem; margin: 0 auto 15px;">ðŸ‘‹</div>
    <h2>Welcome!</h2>
    <p>How old are you, smarty?</p>
    <div class="modal-input-group">
      <input type="number" id="welcomeAgeInput" min="4" max="15" value="8">
    </div>
    <button class="modal-btn" id="startJourneyBtn">Let's Play! <i class="fas fa-rocket"></i></button>
  </div>
</div>

<div class="app">
  <!-- SPLASH SCREEN -->
  <div id="splash-screen">
    <div class="brain-mascot">ðŸ§ </div>
    <h1 class="splash-title">QUICK BRAIN</h1>
    <p style="font-size:1.6rem; font-weight:700; color:#fff; background:rgba(0,0,0,0.2); padding:10px 25px; border-radius:30px; border:3px solid rgba(255,255,255,0.4);">Fun Math Magic!</p>
    <button class="play-now-btn" id="playNowBtn">
      <i class="fas fa-play"></i> START
    </button>
  </div>

  <!-- GAME SCREEN -->
  <div id="game-screen">
    
    <!-- Top Bar with Separated Buttons -->
    <div class="top-bar">
      <button class="btn-chunky btn-icon-only" id="backBtn" style="background:#ff6b6b; border-color:#fff; color:#fff; box-shadow:0 6px 0 #ee5253;"><i class="fas fa-home"></i></button>
      
      <div class="stats">
        <div class="stat-badge streak" id="streakDisplay"><i class="fas fa-fire"></i> 0</div>
        <div class="stat-badge" id="pointsDisplay"><i class="fas fa-coins"></i> 0</div>
      </div>
      
      <div class="action-btns">
        <button class="btn-chunky btn-icon-only" id="shopBtn" style="background:#feca57; box-shadow:0 6px 0 #ff9f43; border-color:#fff; color:#fff;" title="Theme Shop">
          <i class="fas fa-store"></i>
        </button>
        <button class="btn-chunky btn-icon-only" id="settingsBtn" style="background:#48dbfb; box-shadow:0 6px 0 #0abde3; border-color:#fff; color:#fff;" title="Settings">
          <i class="fas fa-cog"></i>
        </button>
      </div>
    </div>

    <!-- Quiz Area -->
    <div class="quiz-card" id="quizCard">
      <!-- New Clean Math Board -->
      <div class="question-board" id="questionArea">
        <!-- Question inserted here by JS -->
      </div>
      
      <div class="answer-row">
        <input type="number" id="answerInput" placeholder="?" autocomplete="off">
        <button class="submit-btn" id="submitBtn"><i class="fas fa-paper-plane"></i></button>
      </div>
    </div>

    <!-- Shop Panel -->
    <div class="panel-card" id="shopPanel">
      <h3 class="panel-title"><i class="fas fa-paint-roller"></i> Theme Shop</h3>
      <div class="shop-grid" id="themeGrid">
        <!-- Themes generated here -->
      </div>
    </div>

    <!-- Settings Panel -->
    <div class="panel-card" id="settingsPanel">
      <h3 class="panel-title"><i class="fas fa-user-cog"></i> Settings</h3>
      <div class="age-selector">
        <span>Player Age:</span>
        <div style="display:flex; gap:10px;">
          <input type="number" id="ageInput" min="4" max="15" value="8">
          <button class="btn-chunky" id="saveAgeBtn" style="background:#1dd1a1; box-shadow:0 5px 0 #10ac84; color:white; padding:5px 20px;"><i class="fas fa-check"></i></button>
        </div>
      </div>
    </div>
    
  </div>
</div>

<script>
  (function() {
    // --- GAME DATA & THEMES ---
    const THEMES = {
      default: { id:'default', name:'Sunny', icon:'â˜€ï¸', particles:['â˜ï¸','â˜€ï¸','ðŸŽˆ'], bg:'#74b9ff', ui:'#ffffff', btn:'#0984e3', shadow:'rgba(0,0,0,0.15)', price:0, tColor:'#ffb142' },
      forest: { id:'forest', name:'Forest', icon:'ðŸŒ³', particles:['ðŸƒ','ðŸ¦‹','ðŸž'], bg:'#55efc4', ui:'#e8f8f5', btn:'#00b894', shadow:'#009432', price:50, tColor:'#00b894' },
      ocean: { id:'ocean', name:'Ocean', icon:'ðŸŒŠ', particles:['ðŸ«§','ðŸŸ','ðŸ¡'], bg:'#48dbfb', ui:'#dff9fb', btn:'#0abde3', shadow:'#0984e3', price:100, tColor:'#0abde3' },
      candy: { id:'candy', name:'Candy', icon:'ðŸ­', particles:['ðŸ¬','ðŸ­','ðŸ©'], bg:'#fda7df', ui:'#fff0f5', btn:'#D980FA', shadow:'#e84393', price:150, tColor:'#fd79a8' },
      space: { id:'space', name:'Space', icon:'ðŸš€', particles:['â­','ðŸš€','ðŸ›¸','ðŸŒ'], bg:'#2f3542', ui:'#57606f', btn:'#ffa502', shadow:'#2ed573', price:200, tColor:'#ffa502' },
      dino: { id:'dino', name:'Jurassic', icon:'ðŸ¦–', particles:['ðŸ¦–','ðŸ¦•','ðŸŒ´','ðŸŒ‹'], bg:'#f39c12', ui:'#fdf3e7', btn:'#d35400', shadow:'#e67e22', price:250, tColor:'#e67e22' },
      unicorn: { id:'unicorn', name:'Magic', icon:'ðŸ¦„', particles:['ðŸ¦„','âœ¨','ðŸŒˆ','ðŸ’–'], bg:'#D980FA', ui:'#f8effc', btn:'#9b59b6', shadow:'#FDA7DF', price:300, tColor:'#9b59b6' },
      robot: { id:'robot', name:'Cyber', icon:'ðŸ¤–', particles:['ðŸ¤–','âš™ï¸','âš¡','ðŸ”‹'], bg:'#7f8c8d', ui:'#ecf0f1', btn:'#34495e', shadow:'#bdc3c7', price:350, tColor:'#34495e' }
    };

    let userAge = localStorage.getItem('brainAge');
    let userPoints = parseInt(localStorage.getItem('brainPoints')) || 0;
    let ownedThemes = JSON.parse(localStorage.getItem('brainOwnedThemes')) || ['default'];
    let equippedTheme = localStorage.getItem('brainEquippedTheme') || 'default';
    let currentStreak = 0;
    let currentQuestion = { num1:0, num2:0, op:'+', ans:0 };
    let audioCtx = null;

    // --- DOM ELEMENTS ---
    const UI = {
      welcomeModal: document.getElementById('welcomeModal'),
      welcomeAgeInput: document.getElementById('welcomeAgeInput'),
      startJourneyBtn: document.getElementById('startJourneyBtn'),
      splash: document.getElementById('splash-screen'),
      game: document.getElementById('game-screen'),
      playBtn: document.getElementById('playNowBtn'),
      backBtn: document.getElementById('backBtn'),
      shopBtn: document.getElementById('shopBtn'),
      settingsBtn: document.getElementById('settingsBtn'),
      shopPanel: document.getElementById('shopPanel'),
      settingsPanel: document.getElementById('settingsPanel'),
      quizCard: document.getElementById('quizCard'),
      questionArea: document.getElementById('questionArea'),
      answerInput: document.getElementById('answerInput'),
      submitBtn: document.getElementById('submitBtn'),
      pointsDisplay: document.getElementById('pointsDisplay'),
      streakDisplay: document.getElementById('streakDisplay'),
      ageInput: document.getElementById('ageInput'),
      saveAgeBtn: document.getElementById('saveAgeBtn'),
      themeGrid: document.getElementById('themeGrid'),
      liveBg: document.getElementById('live-bg')
    };

    // --- INITIALIZATION CHECK ---
    function checkFirstTime() {
      if (!userAge) {
        UI.welcomeModal.classList.add('active');
        UI.splash.style.display = 'none';
      } else {
        UI.splash.style.display = 'flex';
        UI.ageInput.value = userAge;
      }
    }

    UI.startJourneyBtn.addEventListener('click', () => {
      let a = parseInt(UI.welcomeAgeInput.value);
      if(a >= 4 && a <= 99) {
        userAge = a;
        localStorage.setItem('brainAge', userAge);
        UI.ageInput.value = userAge;
        UI.welcomeModal.classList.remove('active');
        UI.splash.style.display = 'flex';
        initAudio(); playSound('pop');
      } else {
        alert("Please enter a valid age!");
      }
    });

    // --- AUDIO SYSTEM ---
    function initAudio() {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if (audioCtx.state === 'suspended') audioCtx.resume();
    }

    function playSound(type) {
      if (!audioCtx) return;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.connect(gain); gain.connect(audioCtx.destination);

      if (type === 'pop') {
        osc.type = 'sine'; osc.frequency.setValueAtTime(400, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(800, audioCtx.currentTime + 0.1);
        gain.gain.setValueAtTime(0.2, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
        osc.start(); osc.stop(audioCtx.currentTime + 0.1);
      } else if (type === 'wrong') {
        osc.type = 'triangle'; osc.frequency.setValueAtTime(200, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.3);
        gain.gain.setValueAtTime(0.3, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
        osc.start(); osc.stop(audioCtx.currentTime + 0.3);
      } else if (type === 'win') {
        osc.type = 'sine'; osc.frequency.setValueAtTime(523.25, audioCtx.currentTime);
        osc.frequency.setValueAtTime(659.25, audioCtx.currentTime + 0.1);
        osc.frequency.setValueAtTime(783.99, audioCtx.currentTime + 0.2);
        gain.gain.setValueAtTime(0.2, audioCtx.currentTime); gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.4);
        osc.start(); osc.stop(audioCtx.currentTime + 0.4);
      }
    }

    // --- PARTICLES & CONFETTI ---
    function updateLiveBackground(themeId) {
      UI.liveBg.innerHTML = '';
      const t = THEMES[themeId];
      if(!t) return;
      const particleCount = 18;
      for(let i=0; i<particleCount; i++) {
        let p = document.createElement('div');
        p.className = 'particle';
        p.innerText = t.particles[Math.floor(Math.random() * t.particles.length)];
        p.style.left = Math.random() * 100 + 'vw';
        p.style.animationDuration = (Math.random() * 12 + 8) + 's';
        p.style.animationDelay = (Math.random() * -20) + 's';
        p.style.fontSize = (Math.random() * 2 + 2) + 'rem';
        UI.liveBg.appendChild(p);
      }
    }

    const canvas = document.getElementById('confetti');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    let particles = [];
    
    function fireConfetti() {
      particles = [];
      const colors = ['#ff4757', '#2ed573', '#1e90ff', '#ffa502', '#ff9ff3', '#feca57'];
      for(let i=0; i<100; i++) {
        particles.push({
          x: canvas.width/2, y: canvas.height/2 + 50,
          r: Math.random()*6+4,
          dx: Math.random()*12-6, dy: Math.random()*-12-3,
          color: colors[Math.floor(Math.random()*colors.length)]
        });
      }
      animateConfetti();
    }
    
    function animateConfetti() {
      ctx.clearRect(0,0, canvas.width, canvas.height);
      let active = false;
      particles.forEach(p => {
        p.x += p.dx; p.y += p.dy; p.dy += 0.35; 
        ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
        ctx.fillStyle = p.color; ctx.fill();
        if(p.y < canvas.height) active = true;
      });
      if(active) requestAnimationFrame(animateConfetti);
      else ctx.clearRect(0,0, canvas.width, canvas.height);
    }
    window.addEventListener('resize', () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; });

    // --- CORE LOGIC ---
    function applyTheme(themeId) {
      const t = THEMES[themeId] || THEMES.default;
      document.documentElement.style.setProperty('--bg-color', t.bg);
      document.documentElement.style.setProperty('--quiz-bg', t.ui);
      document.documentElement.style.setProperty('--button-bg', t.btn);
      document.documentElement.style.setProperty('--card-shadow', t.shadow);
      updateLiveBackground(themeId);
    }

    function generateQuestion() {
      let num1, num2, op, ans;
      let age = parseInt(userAge);
      
      if (age <= 6) {
        num1 = Math.floor(Math.random() * 10) + 1;
        num2 = Math.floor(Math.random() * 5) + 1;
        op = '+'; ans = num1 + num2;
      } else if (age <= 8) {
        num1 = Math.floor(Math.random() * 20) + 10;
        num2 = Math.floor(Math.random() * 10) + 1;
        op = Math.random() > 0.5 ? '+' : '-';
        if(op === '-' && num2 > num1) [num1, num2] = [num2, num1];
        ans = op === '+' ? num1 + num2 : num1 - num2;
      } else if (age <= 10) {
        let r = Math.random();
        if(r < 0.4) {
           num1 = Math.floor(Math.random() * 10) + 2;
           num2 = Math.floor(Math.random() * 10) + 2;
           op = 'Ã—'; ans = num1 * num2;
        } else {
           num1 = Math.floor(Math.random() * 50) + 10;
           num2 = Math.floor(Math.random() * 30) + 5;
           op = Math.random() > 0.5 ? '+' : '-';
           if(op === '-' && num2 > num1) [num1, num2] = [num2, num1];
           ans = op === '+' ? num1 + num2 : num1 - num2;
        }
      } else {
        let r = Math.random();
        if (r < 0.5) {
          num1 = Math.floor(Math.random() * 15) + 3;
          num2 = Math.floor(Math.random() * 12) + 2;
          op = 'Ã—'; ans = num1 * num2;
        } else {
          let divisor = Math.floor(Math.random() * 10) + 2;
          let quotient = Math.floor(Math.random() * 12) + 2;
          num1 = divisor * quotient; num2 = divisor;
          op = 'Ã·'; ans = quotient;
        }
      }
      return { num1, num2, op, ans };
    }

    // NEW Clean Math Renderer
    function renderQuestion() {
      currentQuestion = generateQuestion();
      
      // Using cute colors for symbols so it looks fun but reads as one line
      UI.questionArea.innerHTML = `
        <span>${currentQuestion.num1}</span> 
        <span style="color: #e65100; margin: 0 5px;">${currentQuestion.op}</span> 
        <span>${currentQuestion.num2}</span> 
        <span style="color: #0abde3; margin: 0 5px;">=</span> 
        <span style="color: #e84393;">?</span>
      `;
      
      UI.answerInput.value = '';
      setTimeout(() => UI.answerInput.focus(), 100);
    }

    function updateStatsUI() {
      UI.pointsDisplay.innerHTML = `<i class="fas fa-coins"></i> ${userPoints}`;
      UI.streakDisplay.innerHTML = `<i class="fas fa-fire"></i> ${currentStreak}`;
      localStorage.setItem('brainPoints', userPoints);
    }

    function renderShop() {
      let html = '';
      for (let [id, th] of Object.entries(THEMES)) {
        let isOwned = ownedThemes.includes(id);
        let isEq = equippedTheme === id;
        let canBuy = userPoints >= th.price;
        
        html += `
        <div class="theme-card ${isEq ? 'equipped' : ''}">
          <div class="theme-card-icon">${th.icon}</div>
          <div class="theme-card-name">${th.name}</div>
        `;
        
        if (isEq) {
          html += `<button class="theme-action-btn" style="background:#1dd1a1; box-shadow:0 4px 0 #10ac84;" disabled><i class="fas fa-check"></i> In Use</button>`;
        } else if (isOwned) {
          html += `<button class="theme-action-btn" onclick="equipTheme('${id}')" style="background:#48dbfb; box-shadow:0 4px 0 #0abde3;"><i class="fas fa-magic"></i> Equip</button>`;
        } else {
          html += `<button class="theme-action-btn" onclick="buyTheme('${id}', ${th.price})" style="background:${canBuy? th.tColor : '#bdc3c7'}; box-shadow:0 4px 0 rgba(0,0,0,0.2);" ${!canBuy?'disabled':''}>
            <i class="fas fa-coins"></i> ${th.price}
          </button>`;
        }
        html += `</div>`;
      }
      UI.themeGrid.innerHTML = html;
    }

    window.equipTheme = function(id) {
      equippedTheme = id;
      localStorage.setItem('brainEquippedTheme', id);
      applyTheme(id); playSound('pop'); renderShop();
    };

    window.buyTheme = function(id, price) {
      if(userPoints >= price) {
        userPoints -= price; ownedThemes.push(id);
        localStorage.setItem('brainOwnedThemes', JSON.stringify(ownedThemes));
        updateStatsUI(); playSound('win'); equipTheme(id);
      }
    };

    // --- GAME ACTIONS ---
    function handleAnswer() {
      let val = parseInt(UI.answerInput.value);
      if(isNaN(val)) return;

      if(val === currentQuestion.ans) {
        playSound('win'); fireConfetti(); currentStreak++;
        userPoints += 10 + (Math.floor(currentStreak/3)*5);
        updateStatsUI(); renderShop();
        setTimeout(renderQuestion, 800);
      } else {
        playSound('wrong'); currentStreak = 0; updateStatsUI();
        UI.quizCard.classList.add('shake');
        setTimeout(() => UI.quizCard.classList.remove('shake'), 400);
        
        setTimeout(() => {
          alert("Oops! Wrong answer, try again! ðŸ˜¥");
          UI.answerInput.value = ''; UI.answerInput.focus();
        }, 500);
      }
    }

    // --- EVENTS ---
    UI.playBtn.addEventListener('click', () => {
      initAudio(); playSound('pop');
      UI.splash.style.display = 'none';
      UI.game.style.display = 'block';
      applyTheme(equippedTheme); updateStatsUI(); renderQuestion(); renderShop();
    });

    UI.backBtn.addEventListener('click', () => {
      playSound('pop');
      UI.game.style.display = 'none'; UI.splash.style.display = 'flex';
      UI.settingsPanel.classList.remove('visible');
      UI.shopPanel.classList.remove('visible');
    });

    UI.submitBtn.addEventListener('click', handleAnswer);
    UI.answerInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') handleAnswer(); });

    // Separate buttons logic
    UI.shopBtn.addEventListener('click', () => {
      playSound('pop');
      UI.settingsPanel.classList.remove('visible'); // Hide settings if open
      UI.shopPanel.classList.toggle('visible');
      if (UI.shopPanel.classList.contains('visible')) renderShop();
    });

    UI.settingsBtn.addEventListener('click', () => {
      playSound('pop');
      UI.shopPanel.classList.remove('visible'); // Hide shop if open
      UI.settingsPanel.classList.toggle('visible');
    });

    UI.saveAgeBtn.addEventListener('click', () => {
      playSound('pop');
      let a = parseInt(UI.ageInput.value);
      if(a >= 4 && a <= 99) {
        userAge = a; localStorage.setItem('brainAge', userAge);
        currentStreak = 0; updateStatsUI(); renderQuestion();
        alert('Age saved! Difficulty updated. ðŸŽ¯');
      }
    });

    // Boot
    checkFirstTime();
    applyTheme(equippedTheme);

  })();
</script>
</body>
</html>
